<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ma SÃ³i - Werewolf Companion</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            padding: 12px;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
        }
        h1 { text-align: center; font-size: 1.5em; padding: 16px 0 8px; }
        h1 .emoji { font-size: 1.3em; }
        .subtitle { text-align: center; color: #8b949e; font-size: 0.85em; margin-bottom: 16px; }

        /* â”€â”€â”€ Cards / Panels â”€â”€â”€ */
        .panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
        }
        .panel h2 { font-size: 1.1em; margin-bottom: 12px; }
        .panel h3 { font-size: 1em; margin-bottom: 8px; color: #58a6ff; }

        /* â”€â”€â”€ Inputs â”€â”€â”€ */
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #30363d;
            background: #0d1117;
            color: #e6edf3;
            font-size: 16px;
            margin-bottom: 10px;
            outline: none;
        }
        input[type="text"]:focus { border-color: #58a6ff; }
        input[type="text"]::placeholder { color: #484f58; }

        /* â”€â”€â”€ Buttons â”€â”€â”€ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            color: #fff;
            width: 100%;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: #238636; }
        .btn-primary:hover { background: #2ea043; }
        .btn-danger { background: #da3633; }
        .btn-danger:hover { background: #f85149; }
        .btn-secondary { background: #30363d; }
        .btn-secondary:hover { background: #484f58; }
        .btn-purple { background: #8957e5; }
        .btn-purple:hover { background: #a371f7; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn-row { display: flex; gap: 8px; margin-top: 8px; }
        .btn-row .btn { width: 50%; }
        .btn-sm { padding: 4px 10px; font-size: 12px; width: auto; border-radius: 6px; }

        /* â”€â”€â”€ Hidden â”€â”€â”€ */
        .hidden { display: none !important; }

        /* â”€â”€â”€ Room Code Display â”€â”€â”€ */
        .room-code {
            font-size: 2.5em;
            font-weight: 800;
            letter-spacing: 8px;
            text-align: center;
            color: #58a6ff;
            font-family: 'Courier New', monospace;
            padding: 8px;
            background: #0d1117;
            border-radius: 8px;
            border: 2px dashed #30363d;
            margin: 8px 0;
        }
        .qr-wrap { text-align: center; margin: 12px 0; }
        .qr-wrap canvas { border-radius: 8px; background: #fff; padding: 8px; }

        /* â”€â”€â”€ Role Counter Grid â”€â”€â”€ */
        .faction-header {
            font-size: 0.9em;
            font-weight: 700;
            padding: 8px 0 4px;
            border-bottom: 1px solid #30363d;
            margin-bottom: 6px;
        }
        .faction-soi { color: #f85149; }
        .faction-dan { color: #58a6ff; }
        .faction-trung_lap { color: #d29922; }

        .role-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 4px;
            border-bottom: 1px solid #21262d;
        }
        .role-row:last-child { border-bottom: none; }
        .role-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        .role-emoji { font-size: 1.3em; }
        .role-name { font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .role-counter {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        .role-counter button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #30363d;
            background: #21262d;
            color: #e6edf3;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .role-counter button:active { background: #30363d; }
        .role-counter .count {
            width: 24px;
            text-align: center;
            font-weight: 700;
            font-size: 1em;
        }
        .count-zero { color: #484f58; }
        .count-active { color: #58a6ff; }

        .toggle-expansion {
            text-align: center;
            padding: 8px;
            color: #8b949e;
            cursor: pointer;
            font-size: 0.85em;
        }
        .toggle-expansion:hover { color: #58a6ff; }

        .role-stats {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.9em;
            color: #8b949e;
        }
        .role-stats .match { color: #3fb950; font-weight: 700; }
        .role-stats .mismatch { color: #f85149; font-weight: 700; }

        /* â”€â”€â”€ Player List â”€â”€â”€ */
        .player-list { list-style: none; max-height: 200px; overflow-y: auto; }
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #21262d;
        }
        .player-item:last-child { border-bottom: none; }

        /* â”€â”€â”€ Cheat Sheet â”€â”€â”€ */
        .cheat-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .cheat-table th { text-align: left; padding: 6px 8px; color: #8b949e; border-bottom: 1px solid #30363d; }
        .cheat-table td { padding: 6px 8px; border-bottom: 1px solid #21262d; }
        .cheat-faction-row td { 
            font-weight: 700; 
            padding-top: 10px; 
            border-bottom: 1px solid #30363d;
            font-size: 0.85em;
        }

        /* â”€â”€â”€ 3D Card Flip (Tap-to-Reveal) â”€â”€â”€ */
        .card-scene {
            perspective: 800px;
            width: 220px;
            height: 320px;
            margin: 20px auto;
        }
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
            cursor: pointer;
        }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: 700;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .card-front {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 2px solid #30363d;
        }
        .card-front .card-icon { font-size: 4em; margin-bottom: 12px; }
        .card-front .card-hint { font-size: 0.65em; color: #8b949e; font-weight: 400; margin-top: 12px; }
        .card-back {
            background: linear-gradient(135deg, #161b22, #1f2937);
            border: 2px solid #58a6ff;
            transform: rotateY(180deg);
        }
        .card-back .role-reveal-emoji { font-size: 3em; margin-bottom: 8px; }
        .card-back .role-reveal-name { font-size: 1.4em; color: #58a6ff; }
        .card-back .role-reveal-desc {
            font-size: 0.6em;
            color: #8b949e;
            font-weight: 400;
            margin-top: 10px;
            padding: 0 16px;
            text-align: center;
            line-height: 1.4;
        }

        .reveal-instruction {
            text-align: center;
            color: #8b949e;
            font-size: 0.85em;
            margin-top: 8px;
        }

        /* â”€â”€â”€ Toast â”€â”€â”€ */
        .toast {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #161b22;
            border: 1px solid #30363d;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
        }
        .toast.show { opacity: 1; }

        /* â”€â”€â”€ Status badge â”€â”€â”€ */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .badge-waiting { background: #1f2937; color: #d29922; border: 1px solid #d29922; }
        .badge-ready { background: #0f291e; color: #3fb950; border: 1px solid #3fb950; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container">
    <h1><span class="emoji">ğŸº</span> Ma SÃ³i</h1>
    <p class="subtitle">Werewolf Companion â€” Thay tháº¿ bá»™ bÃ i giáº¥y</p>

    <!-- â•â•â•â•â•â•â•â•â•â• LOGIN VIEW â•â•â•â•â•â•â•â•â•â• -->
    <div id="login-view">
        <div class="panel">
            <h2>ğŸ® Báº¯t Ä‘áº§u chÆ¡i</h2>
            <input type="text" id="nameInput" placeholder="TÃªn cá»§a báº¡n" autocomplete="off">

            <button class="btn btn-primary" onclick="createRoom()" style="margin-bottom: 8px;">
                ğŸ‘‘ Táº¡o phÃ²ng má»›i (Quáº£n trÃ²)
            </button>

            <div style="text-align:center; color:#484f58; font-size:0.85em; padding: 6px 0;">â€” hoáº·c â€”</div>

            <input type="text" id="roomInput" placeholder="Nháº­p mÃ£ phÃ²ng (VD: AB3K)" 
                   style="text-align:center; font-size:1.3em; letter-spacing:4px; text-transform:uppercase;" 
                   maxlength="4" autocomplete="off">
            <button class="btn btn-secondary" onclick="joinRoom()">
                ğŸšª Tham gia phÃ²ng
            </button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â• LOBBY VIEW (Player waiting) â•â•â•â•â•â•â•â•â•â• -->
    <div id="lobby-view" class="hidden">
        <div class="panel">
            <h2>â³ PhÃ²ng chá»</h2>
            <div class="room-code" id="lobby-room-code">----</div>
            <p style="text-align:center; margin: 8px 0;">
                <span class="badge badge-waiting" id="lobby-status">Äang Ä‘á»£i Quáº£n trÃ² chia bÃ i...</span>
            </p>
            <p style="text-align:center; font-size: 1.2em; margin-top: 12px;">
                ğŸ‘¥ NgÆ°á»i chÆ¡i: <b id="lobby-player-count">0</b>
            </p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â• MODERATOR VIEW â•â•â•â•â•â•â•â•â•â• -->
    <div id="mod-view" class="hidden">
        <div class="panel">
            <h3>ğŸ“¢ MÃ£ phÃ²ng â€” Chia sáº» cho báº¡n bÃ¨</h3>
            <div class="room-code" id="mod-room-code">----</div>
            <div class="qr-wrap">
                <img id="qr-img" alt="QR Code" style="width:180px; height:180px; border-radius:8px; display:none;">
                <p id="qr-fallback" class="hidden" style="word-break:break-all; font-size:0.8em; color:#58a6ff;"></p>
            </div>
            <p style="text-align:center; color:#8b949e; font-size:0.8em;">QuÃ©t QR hoáº·c nháº­p mÃ£ Ä‘á»ƒ vÃ o phÃ²ng</p>
        </div>

        <div class="panel">
            <h3>ğŸ‘¥ NgÆ°á»i chÆ¡i (<span id="mod-player-count">0</span>)</h3>
            <ul class="player-list" id="playerList"></ul>
            <p id="no-players-msg" style="color:#484f58; font-size:0.85em; text-align:center; padding:12px;">
                ChÆ°a cÃ³ ngÆ°á»i chÆ¡i nÃ o...
            </p>
        </div>

        <div class="panel" id="role-config-panel">
            <h3>ğŸƒ Chá»n vai trÃ²</h3>
            <div id="role-selector"></div>
            <div id="expansion-roles" class="hidden"></div>
            <div class="toggle-expansion" id="toggle-exp-btn" onclick="toggleExpansion()">
                â–¼ Hiá»‡n thÃªm vai trÃ² má»Ÿ rá»™ng
            </div>

            <div class="role-stats">
                <span>ÄÃ£ chá»n: <span id="total-roles">0</span></span>
                <span>Cáº§n: <span id="total-players-req">0</span></span>
                <span id="match-indicator"></span>
            </div>

            <button class="btn btn-purple" id="assignBtn" onclick="assignRoles()" disabled>
                ğŸ´ XÃ¡o & Chia bÃ i
            </button>
        </div>

        <!-- Cheat Sheet (hidden until roles assigned) -->
        <div class="panel hidden" id="cheat-sheet-panel">
            <h3>ğŸ“‹ Báº£ng theo dÃµi (Chá»‰ Quáº£n trÃ² tháº¥y)</h3>
            <table class="cheat-table" id="cheat-table">
                <thead><tr><th>TÃªn</th><th>Vai trÃ²</th></tr></thead>
                <tbody id="cheat-body"></tbody>
            </table>
            <div class="btn-row" style="margin-top: 12px;">
                <button class="btn btn-danger" onclick="resetRoom()">ğŸ”„ Chia láº¡i</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â• GAME VIEW (Player sees role) â•â•â•â•â•â•â•â•â•â• -->
    <div id="game-view" class="hidden">
        <div class="panel">
            <h2 style="text-align:center;">Vai trÃ² cá»§a báº¡n</h2>
            <div class="card-scene">
                <div class="card" id="role-card"
                     ontouchstart="startReveal(event)" ontouchend="endReveal(event)" ontouchcancel="endReveal(event)"
                     onmousedown="startReveal(event)" onmouseup="endReveal(event)" onmouseleave="endReveal(event)">
                    <div class="card-face card-front">
                        <div class="card-icon">â“</div>
                        <div>Nháº¥n & giá»¯ Ä‘á»ƒ xem</div>
                        <div class="card-hint">BuÃ´ng tay = áº©n bÃ i</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="role-reveal-emoji" id="reveal-emoji">ğŸº</div>
                        <div class="role-reveal-name" id="reveal-name">???</div>
                        <div class="role-reveal-desc" id="reveal-desc"></div>
                    </div>
                </div>
            </div>
            <p class="reveal-instruction">ğŸ‘† Nháº¥n giá»¯ Ä‘á»ƒ láº­t bÃ i â€” BuÃ´ng tay Ä‘á»ƒ Ãºp láº¡i</p>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROLES CONFIG â€” 27 vai trÃ² Ma SÃ³i
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rolesConfig = [
    // â”€â”€ PHE SÃ“I â”€â”€
    { id: 'werewolf',    nameVi: 'SÃ³i',          emoji: 'ğŸº', faction: 'soi', tier: 'core',      maxCount: 4, desc: 'Má»—i Ä‘Ãªm thá»©c dáº­y chá»n 1 ngÆ°á»i Ä‘á»ƒ giáº¿t.' },
    { id: 'alpha_wolf',  nameVi: 'SÃ³i ChÃºa',     emoji: 'ğŸ¾', faction: 'soi', tier: 'expansion', maxCount: 1, desc: 'Má»™t láº§n biáº¿n náº¡n nhÃ¢n thÃ nh SÃ³i thay vÃ¬ giáº¿t.' },
    { id: 'wolf_cub',    nameVi: 'SÃ³i Con',       emoji: 'ğŸ¶', faction: 'soi', tier: 'expansion', maxCount: 1, desc: 'Khi cháº¿t, SÃ³i Ä‘Æ°á»£c cáº¯n 2 ngÆ°á»i Ä‘Ãªm káº¿ tiáº¿p.' },
    { id: 'cursed_wolf', nameVi: 'SÃ³i Nguyá»n',    emoji: 'ğŸ˜ˆ', faction: 'soi', tier: 'expansion', maxCount: 1, desc: 'TiÃªn tri soi ra DÃ¢n. Bá»‹ SÃ³i cáº¯n â†’ thÃ nh SÃ³i.' },

    // â”€â”€ PHE DÃ‚N â”€â”€
    { id: 'villager',     nameVi: 'DÃ¢n LÃ ng',      emoji: 'ğŸ‘¤', faction: 'dan', tier: 'core',      maxCount: 13, desc: 'KhÃ´ng cÃ³ nÄƒng lá»±c Ä‘áº·c biá»‡t.' },
    { id: 'seer',         nameVi: 'TiÃªn Tri',      emoji: 'ğŸ”®', faction: 'dan', tier: 'core',      maxCount: 1,  desc: 'Má»—i Ä‘Ãªm soi 1 ngÆ°á»i, biáº¿t SÃ³i hay DÃ¢n.' },
    { id: 'witch',        nameVi: 'PhÃ¹ Thá»§y',      emoji: 'ğŸ§™â€â™€ï¸', faction: 'dan', tier: 'core',   maxCount: 1,  desc: 'CÃ³ 1 bÃ¬nh cá»©u + 1 bÃ¬nh giáº¿t, dÃ¹ng 1 láº§n.' },
    { id: 'bodyguard',    nameVi: 'Báº£o Vá»‡',        emoji: 'ğŸ›¡ï¸', faction: 'dan', tier: 'core',     maxCount: 1,  desc: 'Má»—i Ä‘Ãªm báº£o vá»‡ 1 ngÆ°á»i, khÃ´ng láº·p 2 Ä‘Ãªm.' },
    { id: 'hunter',       nameVi: 'Thá»£ SÄƒn',       emoji: 'ğŸ¹', faction: 'dan', tier: 'core',      maxCount: 1,  desc: 'Khi cháº¿t, báº¯n cháº¿t 1 ngÆ°á»i báº¥t ká»³.' },
    { id: 'cupid',        nameVi: 'Tháº§n TÃ¬nh YÃªu', emoji: 'ğŸ’˜', faction: 'dan', tier: 'core',      maxCount: 1,  desc: 'ÄÃªm Ä‘áº§u ghÃ©p 2 ngÆ°á»i, 1 cháº¿t â†’ cáº£ 2 cháº¿t.' },
    { id: 'little_girl',  nameVi: 'CÃ´ BÃ©',         emoji: 'ğŸ‘§', faction: 'dan', tier: 'core',      maxCount: 1,  desc: 'HÃ© máº¯t nhÃ¬n khi SÃ³i thá»©c, bá»‹ tháº¥y â†’ cháº¿t.' },
    { id: 'mayor',        nameVi: 'TrÆ°á»Ÿng LÃ ng',   emoji: 'ğŸ‘‘', faction: 'dan', tier: 'core',      maxCount: 1,  desc: 'Phiáº¿u báº§u x2, cháº¿t â†’ chá»‰ Ä‘á»‹nh ngÆ°á»i káº¿.' },
    { id: 'elder',        nameVi: 'GiÃ  LÃ ng',       emoji: 'ğŸ‘´', faction: 'dan', tier: 'expansion', maxCount: 1,  desc: 'Chá»‹u 2 Ä‘Ã²n SÃ³i. Bá»‹ DÃ¢n giáº¿t â†’ máº¥t háº¿t nÄƒng lá»±c.' },
    { id: 'idiot',        nameVi: 'Tháº±ng Ngá»‘c',    emoji: 'ğŸ¤ª', faction: 'dan', tier: 'expansion', maxCount: 1,  desc: 'Bá»‹ treo cá»• â†’ sá»‘ng, máº¥t quyá»n vote.' },
    { id: 'scapegoat',    nameVi: 'Káº» Tháº¿ ThÃ¢n',   emoji: 'ğŸ', faction: 'dan', tier: 'expansion', maxCount: 1,  desc: 'Vote hÃ²a â†’ cháº¿t thay, chá»n ai vote ngÃ y sau.' },
    { id: 'raven',        nameVi: 'Con Quáº¡',        emoji: 'ğŸ¦â€â¬›', faction: 'dan', tier: 'expansion', maxCount: 1, desc: 'Má»—i Ä‘Ãªm gá»­i thÆ° â†’ náº¡n nhÃ¢n +2 phiáº¿u.' },
    { id: 'knight',       nameVi: 'Hiá»‡p SÄ©',       emoji: 'âš”ï¸', faction: 'dan', tier: 'expansion', maxCount: 1,  desc: 'Bá»‹ SÃ³i giáº¿t â†’ SÃ³i bÃªn trÃ¡i cháº¿t theo.' },
    { id: 'two_sisters',  nameVi: 'Hai Chá»‹ Em',     emoji: 'ğŸ‘¯', faction: 'dan', tier: 'expansion', maxCount: 2,  desc: '2 ngÆ°á»i biáº¿t máº·t nhau, Ä‘Ãªm trao Ä‘á»•i ngáº¯n.' },
    { id: 'three_brothers', nameVi: 'Ba Anh Em',    emoji: 'ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦', faction: 'dan', tier: 'expansion', maxCount: 3, desc: '3 ngÆ°á»i biáº¿t máº·t nhau, Ä‘Ãªm trao Ä‘á»•i ngáº¯n.' },
    { id: 'fox',          nameVi: 'Con CÃ¡o',        emoji: 'ğŸ¦Š', faction: 'dan', tier: 'expansion', maxCount: 1,  desc: 'Chá»n 1 ngÆ°á»i, biáº¿t nhÃ³m 3 cÃ³ SÃ³i khÃ´ng.' },
    { id: 'bear_tamer',   nameVi: 'Gáº¥u',            emoji: 'ğŸ»', faction: 'dan', tier: 'expansion', maxCount: 1,  desc: 'Ngá»“i cáº¡nh SÃ³i â†’ quáº£n trÃ² bÃ¡o "Gáº¥u gáº§m".' },
    { id: 'pyromaniac',   nameVi: 'PhÃ³ng Há»a',     emoji: 'ğŸ”¥', faction: 'dan', tier: 'expansion', maxCount: 1,  desc: '1 láº§n Ä‘á»‘t nhÃ , SÃ³i cáº¯n Ä‘Ã³ â†’ SÃ³i cháº¿t.' },

    // â”€â”€ TRUNG Láº¬P â”€â”€
    { id: 'thief',       nameVi: 'Ä‚n Trá»™m',        emoji: 'ğŸ¤', faction: 'trung_lap', tier: 'core',      maxCount: 1, desc: 'ÄÃªm Ä‘áº§u xem 2 lÃ¡ dÆ°, chá»n 1 thay vai.' },
    { id: 'pied_piper',  nameVi: 'Thá»•i SÃ¡o',       emoji: 'ğŸµ', faction: 'trung_lap', tier: 'expansion', maxCount: 1, desc: 'Má»—i Ä‘Ãªm thÃ´i miÃªn 2 ngÆ°á»i. Tháº¯ng khi táº¥t cáº£ bá»‹ miÃªn.' },
    { id: 'white_wolf',  nameVi: 'SÃ³i Tráº¯ng',      emoji: 'ğŸº', faction: 'trung_lap', tier: 'expansion', maxCount: 1, desc: 'CÃ¹ng phe SÃ³i nhÆ°ng cá»© 2 Ä‘Ãªm giáº¿t 1 SÃ³i.' },
    { id: 'angel',       nameVi: 'ThiÃªn Sá»©',       emoji: 'ğŸ˜‡', faction: 'trung_lap', tier: 'expansion', maxCount: 1, desc: 'Tháº¯ng náº¿u bá»‹ loáº¡i Ä‘Ãªm/ngÃ y Ä‘áº§u tiÃªn.' },
    { id: 'wild_child',  nameVi: 'Tráº» Hoang',      emoji: 'ğŸ§’', faction: 'trung_lap', tier: 'expansion', maxCount: 1, desc: 'Chá»n idol, idol cháº¿t â†’ thÃ nh SÃ³i.' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const socket = io(window.location.origin, {
    transports: ['websocket', 'polling'],
    reconnection: true,
    reconnectionAttempts: 10,
    reconnectionDelay: 1000
});
let currentRoom = '';
let isModerator = false;
let selectedRoles = {};   // { roleId: count }
let showExpansion = false;
let revealTimer = null;
const REVEAL_DELAY = 300; // ms â€” long-press protection

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const views = {
    login: document.getElementById('login-view'),
    lobby: document.getElementById('lobby-view'),
    mod:   document.getElementById('mod-view'),
    game:  document.getElementById('game-view')
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-FILL Room Code from URL  (?room=XXXX)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function autoFillRoom() {
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    if (room) {
        document.getElementById('roomInput').value = room.toUpperCase();
    }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(name) {
    Object.values(views).forEach(v => v.classList.add('hidden'));
    views[name].classList.remove('hidden');
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(t._timer);
    t._timer = setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createRoom() {
    const name = document.getElementById('nameInput').value.trim();
    if (!name) return showToast('Nháº­p tÃªn cá»§a báº¡n trÆ°á»›c!');
    socket.emit('create_room');
    isModerator = true;
}

function joinRoom() {
    const name = document.getElementById('nameInput').value.trim();
    const room = document.getElementById('roomInput').value.trim().toUpperCase();
    if (!name) return showToast('Nháº­p tÃªn cá»§a báº¡n trÆ°á»›c!');
    if (!room || room.length < 4) return showToast('Nháº­p mÃ£ phÃ²ng 4 kÃ½ tá»±!');
    currentRoom = room;
    socket.emit('join_room', { roomId: room, name });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROLE COUNTER UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const factionMeta = {
    'soi':       { label: 'ğŸº Phe SÃ³i',     cssClass: 'faction-soi' },
    'dan':       { label: 'ğŸ‘¥ Phe DÃ¢n LÃ ng', cssClass: 'faction-dan' },
    'trung_lap': { label: 'âš–ï¸ Trung Láº­p',   cssClass: 'faction-trung_lap' }
};

function renderRoleSelector() {
    const coreContainer = document.getElementById('role-selector');
    const expContainer  = document.getElementById('expansion-roles');
    coreContainer.innerHTML = '';
    expContainer.innerHTML = '';

    const factions = ['soi', 'dan', 'trung_lap'];

    factions.forEach(faction => {
        const coreRoles = rolesConfig.filter(r => r.faction === faction && r.tier === 'core');
        const expRoles  = rolesConfig.filter(r => r.faction === faction && r.tier === 'expansion');
        const meta = factionMeta[faction];

        if (coreRoles.length > 0) {
            coreContainer.innerHTML += `<div class="faction-header ${meta.cssClass}">${meta.label}</div>`;
            coreRoles.forEach(role => { coreContainer.innerHTML += roleRowHTML(role); });
        }

        if (expRoles.length > 0) {
            expContainer.innerHTML += `<div class="faction-header ${meta.cssClass}">${meta.label} (Má»Ÿ rá»™ng)</div>`;
            expRoles.forEach(role => { expContainer.innerHTML += roleRowHTML(role); });
        }
    });
}

function roleRowHTML(role) {
    const count = selectedRoles[role.id] || 0;
    return `
        <div class="role-row" title="${role.desc}">
            <div class="role-info">
                <span class="role-emoji">${role.emoji}</span>
                <span class="role-name">${role.nameVi}</span>
            </div>
            <div class="role-counter">
                <button onclick="updateRole('${role.id}', -1)">âˆ’</button>
                <span class="count ${count > 0 ? 'count-active' : 'count-zero'}" id="cnt-${role.id}">${count}</span>
                <button onclick="updateRole('${role.id}', 1)">+</button>
            </div>
        </div>`;
}

function updateRole(id, delta) {
    const role = rolesConfig.find(r => r.id === id);
    if (!role) return;
    const current = selectedRoles[id] || 0;
    const next = Math.max(0, Math.min(role.maxCount, current + delta));
    selectedRoles[id] = next;

    const el = document.getElementById(`cnt-${id}`);
    if (el) {
        el.textContent = next;
        el.className = 'count ' + (next > 0 ? 'count-active' : 'count-zero');
    }
    updateRoleStats();
}

function toggleExpansion() {
    showExpansion = !showExpansion;
    document.getElementById('expansion-roles').classList.toggle('hidden', !showExpansion);
    document.getElementById('toggle-exp-btn').textContent =
        showExpansion ? 'â–² áº¨n vai trÃ² má»Ÿ rá»™ng' : 'â–¼ Hiá»‡n thÃªm vai trÃ² má»Ÿ rá»™ng';
}

function getTotalRoles() {
    return Object.values(selectedRoles).reduce((a, b) => a + b, 0);
}

function updateRoleStats() {
    const total = getTotalRoles();
    const req = parseInt(document.getElementById('total-players-req').textContent) || 0;
    document.getElementById('total-roles').textContent = total;

    const indicator = document.getElementById('match-indicator');
    const btn = document.getElementById('assignBtn');
    if (total === req && total > 0) {
        indicator.innerHTML = '<span class="match">âœ“ Khá»›p!</span>';
        btn.disabled = false;
    } else {
        indicator.innerHTML = `<span class="mismatch">${total > req ? 'â†‘ Thá»«a' : 'â†“ Thiáº¿u'}</span>`;
        btn.disabled = true;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSIGN ROLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function assignRoles() {
    // Build flat array from selectedRoles
    const roleArray = [];
    for (const [id, count] of Object.entries(selectedRoles)) {
        const role = rolesConfig.find(r => r.id === id);
        if (role && count > 0) {
            for (let i = 0; i < count; i++) {
                roleArray.push(role.nameVi);
            }
        }
    }
    socket.emit('start_assign_roles', { roomId: currentRoom, selectedRoles: roleArray });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESET / RE-DEAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetRoom() {
    if (!confirm('Chia láº¡i bÃ i? Táº¥t cáº£ ngÆ°á»i chÆ¡i sáº½ quay vá» phÃ²ng chá».')) return;
    socket.emit('reset_room', { roomId: currentRoom });
    document.getElementById('cheat-sheet-panel').classList.add('hidden');
    document.getElementById('role-config-panel').classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR CODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQR(code) {
    const url = `${window.location.origin}?room=${code}`;
    const img = document.getElementById('qr-img');
    const fallback = document.getElementById('qr-fallback');

    if (typeof QRCode !== 'undefined') {
        QRCode.toDataURL(url, {
            width: 180,
            margin: 1,
            color: { dark: '#000000', light: '#ffffff' }
        }, function(err, dataUrl) {
            if (err) {
                console.error('QR error:', err);
                fallback.textContent = url;
                fallback.classList.remove('hidden');
                return;
            }
            img.src = dataUrl;
            img.style.display = 'block';
            img.style.margin = '0 auto';
        });
    } else {
        // CDN failed â€” show link as fallback
        fallback.innerHTML = `<a href="${url}" style="color:#58a6ff;">${url}</a>`;
        fallback.classList.remove('hidden');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAP-TO-REVEAL (Long-press 300ms + 3D Flip)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startReveal(e) {
    e.preventDefault();
    revealTimer = setTimeout(() => {
        document.getElementById('role-card').classList.add('is-flipped');
        if ('vibrate' in navigator) navigator.vibrate(100);
    }, REVEAL_DELAY);
}

function endReveal(e) {
    e.preventDefault();
    clearTimeout(revealTimer);
    document.getElementById('role-card').classList.remove('is-flipped');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODERATOR CHEAT SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCheatSheet(summary) {
    const body = document.getElementById('cheat-body');
    body.innerHTML = '';

    // Resolve faction for each role name
    const enriched = summary.map(s => {
        const cfg = rolesConfig.find(r => r.nameVi === s.role);
        return { ...s, faction: cfg ? cfg.faction : 'dan', emoji: cfg ? cfg.emoji : 'â“' };
    });

    // Group by faction
    const groups = { 'soi': [], 'dan': [], 'trung_lap': [] };
    enriched.forEach(e => {
        (groups[e.faction] || groups['dan']).push(e);
    });

    const fLabels = { 'soi': 'ğŸº Phe SÃ³i', 'dan': 'ğŸ‘¥ Phe DÃ¢n', 'trung_lap': 'âš–ï¸ Trung Láº­p' };
    ['soi', 'trung_lap', 'dan'].forEach(f => {
        if (groups[f].length === 0) return;
        body.innerHTML += `<tr class="cheat-faction-row"><td colspan="2">${fLabels[f]}</td></tr>`;
        groups[f].forEach(p => {
            body.innerHTML += `<tr><td>${p.name}</td><td>${p.emoji} ${p.role}</td></tr>`;
        });
    });

    document.getElementById('cheat-sheet-panel').classList.remove('hidden');
    document.getElementById('role-config-panel').classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KICK PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function kick(playerId) {
    if (!confirm('Kick ngÆ°á»i chÆ¡i nÃ y?')) return;
    socket.emit('kick_player', { roomId: currentRoom, playerId });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('room_created', ({ roomCode }) => {
    currentRoom = roomCode;
    document.getElementById('mod-room-code').textContent = roomCode;
    renderQR(roomCode);
    renderRoleSelector();
    showView('mod');
});

socket.on('role_assigned', ({ type, roomCode }) => {
    if (type === 'moderator') {
        showView('mod');
    } else {
        if (roomCode) currentRoom = roomCode;
        document.getElementById('lobby-room-code').textContent = currentRoom;
        showView('lobby');
    }
});

socket.on('error_msg', (msg) => {
    showToast('âš ï¸ ' + msg);
});

socket.on('player_count_update', (count) => {
    document.getElementById('lobby-player-count').textContent = count;
    document.getElementById('mod-player-count').textContent = count;
    document.getElementById('total-players-req').textContent = count;
    updateRoleStats();
});

socket.on('player_list_update', (players) => {
    const list = document.getElementById('playerList');
    const noMsg = document.getElementById('no-players-msg');
    list.innerHTML = '';

    if (players.length === 0) {
        noMsg.classList.remove('hidden');
    } else {
        noMsg.classList.add('hidden');
        players.forEach((p, i) => {
            const li = document.createElement('li');
            li.className = 'player-item';
            li.innerHTML = `
                <span>${i + 1}. <b>${p.name}</b></span>
                <button class="btn btn-danger btn-sm" onclick="kick('${p.id}')">Kick</button>`;
            list.appendChild(li);
        });
    }
});

socket.on('receive_role', (roleName) => {
    // Find role config
    const cfg = rolesConfig.find(r => r.nameVi === roleName);
    document.getElementById('reveal-emoji').textContent = cfg ? cfg.emoji : 'â“';
    document.getElementById('reveal-name').textContent = roleName;
    document.getElementById('reveal-desc').textContent = cfg ? cfg.desc : '';

    showView('game');
    showToast('ğŸ´ BÃ i Ä‘Ã£ Ä‘Æ°á»£c chia!');
    if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
});

socket.on('role_summary', (summary) => {
    renderCheatSheet(summary);
});

socket.on('status_msg', (msg) => {
    showToast('âœ… ' + msg);
});

socket.on('room_reset', () => {
    if (!isModerator) {
        document.getElementById('role-card').classList.remove('is-flipped');
        showView('lobby');
        showToast('ğŸ”„ Quáº£n trÃ² Ä‘ang chia láº¡i bÃ i...');
    }
});

socket.on('kicked', () => {
    showToast('ğŸš« Báº¡n Ä‘Ã£ bá»‹ kick khá»i phÃ²ng.');
    setTimeout(() => { showView('login'); }, 1500);
});

socket.on('mod_status_update', ({ hasModerator }) => {
    if (!hasModerator && !isModerator) {
        showToast('Quáº£n trÃ² Ä‘Ã£ rá»i phÃ²ng!');
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA â€” Service Worker Registration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderRoleSelector();
</script>
</body>
</html>